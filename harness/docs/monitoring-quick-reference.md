# Session Monitoring - Quick Reference

**Version**: 1.0 | **Date**: 2026-01-27

---

## Quick Commands

### Watch Active Session (Real-time)
```bash
./scripts/parse-session-events.sh watch $(cat state/current-session.json | jq -r '.session_id')
```

### Latest Session Summary
```bash
./scripts/parse-session-events.sh latest
```

### List All Sessions
```bash
./scripts/parse-session-events.sh list
```

---

## Session Analysis

### Get Session ID
```bash
# Current session
session_id=$(cat state/current-session.json | jq -r '.session_id')

# Latest completed session
session_id=$(ls -t docs/sessions/ses_*.log | head -1 | xargs basename .log)
```

### Full Analysis
```bash
# Summary (overview)
./scripts/parse-session-events.sh summary $session_id

# All tool calls
./scripts/parse-session-events.sh tools $session_id

# Errors only
./scripts/parse-session-events.sh errors $session_id

# Event timeline
./scripts/parse-session-events.sh timeline $session_id

# Detailed metrics
./scripts/parse-session-events.sh metrics $session_id
```

---

## Debugging

### Check Session Status
```bash
jq '.' state/current-session.json
```

### Check Heartbeat
```bash
jq '.heartbeat' state/current-session.json
```

### Check Progress
```bash
jq '.progress' state/current-session.json
```

### View Recent Events
```bash
tail -20 docs/sessions/${session_id}.log | jq '.'
```

### Check for Errors in Stderr
```bash
cat docs/sessions/${session_id}.err
```

---

## File Locations

| File | Location | Purpose |
|------|----------|---------|
| **Session State** | `state/current-session.json` | Active session metadata |
| **Stdout Log** | `docs/sessions/{id}.log` | Stream-JSON events |
| **Stderr Log** | `docs/sessions/{id}.err` | Error output |
| **Transcript** | `~/.claude/transcripts/{id}.jsonl` | Full conversation |
| **Events** | `state/sessions/{id}/events.jsonl` | Parsed events |
| **Errors** | `state/sessions/{id}/errors.jsonl` | Error events |
| **Metrics** | `state/sessions/{id}/metrics.json` | Session metrics |

---

## Configuration

### Environment Variables
```bash
SESSION_TIMEOUT=3600          # Session timeout (seconds)
STALL_THRESHOLD=300           # Stall detection (seconds)
INTERRUPT_CHECK_INTERVAL=30   # Monitor frequency (seconds)
MAX_CONSECUTIVE_FAILURES=5    # Spawn failure threshold
```

### Quick Presets

**Fast Tasks** (< 5 min):
```bash
SESSION_TIMEOUT=300 STALL_THRESHOLD=120 INTERRUPT_CHECK_INTERVAL=15
```

**Long Tasks** (> 1 hour):
```bash
SESSION_TIMEOUT=7200 STALL_THRESHOLD=600 INTERRUPT_CHECK_INTERVAL=60
```

**Debug Mode**:
```bash
SESSION_TIMEOUT=600 STALL_THRESHOLD=60 INTERRUPT_CHECK_INTERVAL=10
```

---

## Common Operations

### Force Stop Session
```bash
session_id=$(cat state/current-session.json | jq -r '.session_id')
pid=$(cat state/${session_id}.pid)
kill -TERM $pid
```

### Clear Interrupt
```bash
rm -f state/interrupt-request.txt
```

### Archive Old Sessions
```bash
find docs/sessions -name "*.log" -mtime +30 -exec gzip {} \;
```

### Export Session Data
```bash
./scripts/parse-session-events.sh export $session_id
# Output: docs/sessions/{session_id}-events.json
```

---

## Troubleshooting

### Session Stuck?
```bash
# Check if agent is running
kill -0 $(cat state/current-session.json | jq -r '.pid')

# Check last heartbeat
jq '.heartbeat.last_check' state/current-session.json

# Force kill if needed
kill -9 $(cat state/current-session.json | jq -r '.pid')
```

### No Output?
```bash
# Check log file size
ls -lh docs/sessions/${session_id}.log

# Check if log file is being written
tail -f docs/sessions/${session_id}.log
```

### High Token Usage?
```bash
# View metrics
./scripts/parse-session-events.sh metrics $session_id

# Check total tokens
jq '.api_usage.total_tokens' state/sessions/${session_id}/metrics.json
```

### Background Processor Died?
```bash
# Check processor PID
cat state/${session_id}.processor.pid

# Restart manually (if needed)
tail -f docs/sessions/${session_id}.log | while read line; do
  echo "$line" >> state/sessions/${session_id}/events.jsonl
done &
```

---

## Metrics Reference

### API Usage
- **input_tokens**: Tokens sent to model (context + prompt)
- **output_tokens**: Tokens generated by model (response)
- **total_tokens**: Sum of input + output

### Session Metrics
- **duration_seconds**: Total session runtime
- **turns**: Number of assistant messages (back-and-forth)

### Tool Usage
- **total_calls**: Number of tool invocations
- **breakdown**: Per-tool call counts (Read, Bash, Edit, etc.)

---

## Event Types (Stream-JSON)

| Event Type | Description | Action |
|------------|-------------|--------|
| `message_start` | New message begins | Log start |
| `message_stop` | Message complete | Update heartbeat |
| `tool_use` | Tool invocation | Log tool name |
| `error` | Error occurred | Log to errors.jsonl |
| `content_block_delta` | Content streaming | Extract text |
| `message_delta` | Metadata update | Check usage stats |

---

## Status Codes

### Session Status
- `spawning` - Session initializing
- `running` - Agent actively working
- `completing` - Wrapping up work
- `completed` - Finished successfully
- `failed` - Error occurred
- `interrupted` - Paused for human
- `timeout` - Exceeded time limit
- `killed` - Forcefully terminated

### Exit Codes
- `0` - Success
- `1` - General error
- `124` - Timeout (from `timeout` command)
- Other - Specific error (check stderr)

---

## Best Practices

### Monitoring
1. Watch sessions in real-time during development
2. Check metrics after each session
3. Archive old logs weekly
4. Set up alerts for high token usage

### Debugging
1. Always check stderr first (`*.err` file)
2. Check heartbeat before declaring stalled
3. Review timeline for unusual patterns
4. Compare metrics across similar sessions

### Performance
1. Use SSD for state directory
2. Rotate logs > 30 days
3. Don't run too many concurrent sessions (< 10)
4. Monitor disk space in logs directory

---

## See Also

- **Full Documentation**: `docs/monitoring-system.md`
- **Test Suite**: `tests/test-monitoring.sh`
- **Implementation Notes**: `docs/sessions/2026-01-27-monitoring-implementation-complete.md`
- **Architecture**: `docs/research/spawn-mechanism-architecture.md`

---

**Quick Reference Version**: 1.0
**Last Updated**: 2026-01-27
